{% extends "layout.html" %} {% block title %}Nhận Diện Biển Số - Quản Lý Bãi Đỗ
Xe{% endblock %} {% block nav_detect %}active{% endblock %} {% block page_title
%}Nhận Diện Biển Số{% endblock %} {% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang Chủ</a></li>
<li class="breadcrumb-item active">Nhận Diện Biển Số</li>
{% endblock %} {% block main_content %}
<div class="row">
    <div class="col-md-6">
        <!-- Camera Card -->
        <div class="card card-info">
            <div class="card-header">
                <h3 class="card-title">Kết Nối Camera</h3>
            </div>
            <div class="card-body">
                <div class="text-center mb-2">
                    <video
                        id="camera-video"
                        autoplay
                        playsinline
                        style="width: 100%; max-height: 360px; background: #000"
                    ></video>
                    <canvas id="camera-canvas" style="display: none"></canvas>
                </div>

                <div class="d-flex justify-content-between">
                    <div>
                        <button
                            id="start-camera"
                            class="btn btn-success btn-sm"
                        >
                            <i class="fas fa-video"></i> Bắt đầu
                        </button>
                        <button
                            id="stop-camera"
                            class="btn btn-danger btn-sm"
                            disabled
                        >
                            <i class="fas fa-stop-circle"></i> Dừng
                        </button>
                    </div>
                    <div>
                        <button id="capture-now" class="btn btn-primary btn-sm">
                            <i class="fas fa-camera"></i> Chụp & Nhận diện
                        </button>
                        <label class="ml-2"
                            >Tự động:
                            <input id="auto-capture" type="checkbox" />
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <!-- Upload Image Card -->
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">Tải Ảnh Lên</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <form
                    id="upload-form"
                    action="/detect"
                    method="post"
                    enctype="multipart/form-data"
                >
                    <div class="form-group">
                        <label for="image-upload"
                            >Chọn ảnh chứa biển số xe</label
                        >
                        <div class="input-group">
                            <div class="custom-file">
                                <input
                                    type="file"
                                    class="custom-file-input"
                                    id="image-upload"
                                    name="image"
                                    accept="image/*"
                                    required
                                />
                                <label
                                    class="custom-file-label"
                                    for="image-upload"
                                    >Chọn file...</label
                                >
                            </div>
                        </div>
                    </div>

                    <!-- OCR Engine Selection -->
                    <div class="form-group">
                        <label for="ocr-engine">Chọn OCR Engine</label>
                        <select
                            class="form-control"
                            id="ocr-engine"
                            name="ocr_engine"
                        >
                            <option value="paddle" selected>
                                PaddleOCR (Khuyến nghị)
                            </option>
                            <option value="tesseract">Tesseract OCR</option>
                        </select>
                        <small class="form-text text-muted">
                            PaddleOCR thường cho kết quả tốt hơn với biển số xe
                            Việt Nam
                        </small>
                    </div>

                    <!-- Preview Area -->
                    <div class="form-group">
                        <div id="image-preview" style="display: none">
                            <img
                                id="preview-img"
                                src=""
                                alt="Preview"
                                class="img-fluid"
                                style="max-height: 300px"
                            />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Nhận Diện
                    </button>
                    <button
                        type="button"
                        class="btn btn-warning ml-2"
                        onclick="stopAllProcessing()"
                    >
                        <i class="fas fa-stop"></i> Dừng Tất Cả
                    </button>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>

  <div class="col-md-6">
    <!-- Results Card -->
    <div class="card card-success">
      <div class="card-header">
        <h3 class="card-title">Kết Quả Nhận Diện</h3>
      </div>
      <!-- /.card-header -->
      <div class="card-body">
        <div id="detection-results" style="display: none">
          <!-- Detected plate image -->
          <div class="text-center mb-3">
            <img
              id="detected-plate"
              src=""
              alt="Biển số được nhận diện"
              class="img-fluid border"
            />
          </div>

          <!-- Detected text -->
          <div class="alert alert-success">
            <h5><i class="icon fas fa-check"></i> Biển số nhận diện được:</h5>
            <h3 id="detected-text" class="text-center"></h3>
          </div>

          <!-- Confidence score -->
          <div class="info-box">
            <span class="info-box-icon bg-success"
              ><i class="fas fa-percent"></i
            ></span>
            <div class="info-box-content">
              <span class="info-box-text">Độ tin cậy</span>
              <span class="info-box-number" id="confidence-score">0%</span>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="text-center mt-3">
            <button class="btn btn-primary" onclick="saveResult()">
              <i class="fas fa-save"></i> Lưu Kết Quả
            </button>
            <button class="btn btn-secondary" onclick="resetForm()">
              <i class="fas fa-redo"></i> Nhận Diện Mới
            </button>
          </div>
        </div>

        <div id="no-results" class="text-center text-muted">
          <i class="fas fa-image fa-3x mb-3"></i>
          <p>Tải ảnh lên để bắt đầu nhận diện biển số xe</p>
        </div>
      </div>
      <!-- /.card-body -->
    </div>
    <!-- /.card -->
  </div>
</div>

<!-- Recent Detection History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Lịch Sử Nhận Diện Gần Đây</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr class="text-black">
                            <th>STT</th>
                            <th>Thời Gian</th>
                            <th>Ảnh Gốc</th>
                            <th>Biển Số</th>
                            <th>Độ Tin Cậy</th>
                            <th>Trạng Thái</th>
                            <th>Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody id="detection-history">
                        <!-- History rows will be loaded here -->
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Chưa có dữ liệu
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>
{% endblock %} {% block page_scripts %}
<script>
    $(document).ready(function () {
        // If server passed initial history, render it (always produce a JS array)
        const initialHistory = {{ history|default([])|tojson }};
        if (initialHistory && initialHistory.length) {
            updateHistory(initialHistory);
        }

        // Variable to track ongoing requests
        let currentRequest = null;

        // Handle file input change
        $("#image-upload").on("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $("#preview-img").attr("src", e.target.result);
                    $("#image-preview").show();
                };
                reader.readAsDataURL(file);

        // Update file label
        $(".custom-file-label").text(file.name);
      }
    });

        // Handle form submission
        $("#upload-form").on("submit", function (e) {
            e.preventDefault();

            // Abort any ongoing request
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
            }

      const formData = new FormData(this);

            // Show loading state with cancel button
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn
                .html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý... <button type="button" class="btn btn-sm btn-danger ml-2" onclick="cancelProcessing()">Hủy</button>')
                .prop("disabled", false);

            currentRequest = $.ajax({
                url: "/detect",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                timeout: 30000, // 30 second timeout
                success: function (response) {
                    currentRequest = null;
                    if (response.success) {
                        displayResults(response);
                    } else {
                        showError(
                            response.message ||
                                "Có lỗi xảy ra khi nhận diện biển số"
                        );
                    }
                },
                error: function (xhr, status, error) {
                    currentRequest = null;
                    if (status === 'abort') {
                        showError("Đã hủy quá trình xử lý");
                    } else if (status === 'timeout') {
                        showError("Quá thời gian xử lý. Vui lòng thử lại.");
                    } else {
                        showError("Có lỗi xảy ra khi kết nối với máy chủ: " + error);
                    }
                },
                complete: function () {
                    // Restore button state
                    submitBtn.html(originalText).prop("disabled", false);
                    currentRequest = null;
                },
            });
        });

        // Global function to cancel processing
        window.cancelProcessing = function() {
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
                showError("Đã dừng quá trình xử lý");
            }
        };

        // Global function to stop all processing
        window.stopAllProcessing = function() {
            // Stop form upload request
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
            }

            // Stop camera request
            if (cameraRequest) {
                cameraRequest.abort();
                cameraRequest = null;
            }

            // Stop auto capture
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                document.getElementById('auto-capture').checked = false;
            }

            // Reset button states
            const submitBtn = $("#upload-form").find('button[type="submit"]');
            submitBtn.html('<i class="fas fa-search"></i> Nhận Diện').prop("disabled", false);

            showError("Đã dừng tất cả các tiến trình xử lý");
        };
    });

    // Camera controls
    let stream = null;
    let autoInterval = null;
    let cameraRequest = null;

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
            const video = document.getElementById('camera-video');
            video.srcObject = stream;
            document.getElementById('start-camera').disabled = true;
            document.getElementById('stop-camera').disabled = false;
        } catch (err) {
            showError('Không thể truy cập camera: ' + err.message);
        }
    }

    function stopCamera() {
        // Cancel any ongoing camera request
        if (cameraRequest) {
            cameraRequest.abort();
            cameraRequest = null;
        }

        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        document.getElementById('start-camera').disabled = false;
        document.getElementById('stop-camera').disabled = true;
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
    }

    async function captureAndSend() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        if (!video || !stream) return showError('Camera chưa được bật');

        // Cancel previous camera request if exists
        if (cameraRequest) {
            cameraRequest.abort();
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(async function (blob) {
            const fd = new FormData();
            fd.append('image', blob, 'capture.jpg');
            // Thêm OCR engine từ form
            const ocrEngine = document.getElementById('ocr-engine').value;
            fd.append('ocr_engine', ocrEngine);

            try {
                // Create AbortController for this request
                const controller = new AbortController();
                cameraRequest = controller;

                const res = await fetch('/detect', {
                    method: 'POST',
                    body: fd,
                    signal: controller.signal,
                    timeout: 30000
                });

                const data = await res.json();
                cameraRequest = null;

                if (data.success) displayResults(data);
                else showError(data.message || 'Nhận diện thất bại');
            } catch (err) {
                cameraRequest = null;
                if (err.name === 'AbortError') {
                    showError('Đã hủy quá trình nhận diện camera');
                } else {
                    showError('Lỗi kết nối: ' + err.message);
                }
            }
        }, 'image/jpeg', 0.8);
    }

    // Attach camera button handlers
    document.getElementById('start-camera').addEventListener('click', startCamera);
    document.getElementById('stop-camera').addEventListener('click', stopCamera);
    document.getElementById('capture-now').addEventListener('click', captureAndSend);
    document.getElementById('auto-capture').addEventListener('change', function (e) {
        if (e.target.checked) {
            // every 3 seconds
            autoInterval = setInterval(captureAndSend, 2000);
        } else {
            if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
        }
    });

    function displayResults(response) {
        $("#detected-plate").attr("src", response.plate_image);
        $("#detected-text").text(response.plate_text);
        $("#confidence-score").text(
            Math.round(response.confidence * 100) + "%"
        );

    $("#no-results").hide();
    $("#detection-results").show();

        // Add to history (if available)
        if (response.history) {
            updateHistory(response.history, response.confidence);
        }
    }

  function showError(message) {
    toastr.error(message, "Lỗi");
  }

  function saveResult() {
    // Implementation for saving result
    toastr.success("Kết quả đã được lưu thành công!", "Thành công");
    setTimeout(function () {
      location.reload();
    }, 1200); // Đợi toast hiển thị xong rồi reload
  }

  function resetForm() {
    $("#upload-form")[0].reset();
    $("#image-preview").hide();
    $("#detection-results").hide();
    $("#no-results").show();
    $(".custom-file-label").text("Chọn file...");
  }

    function updateHistory(historyData) {
        const tbody = $("#detection-history");
        tbody.empty();
        if (!historyData || historyData.length === 0) {
            tbody.append(`<tr><td colspan="7" class="text-center text-muted">Chưa có dữ liệu</td></tr>`);
            return;
        }

        historyData.forEach((rec, idx) => {
            const created = rec.created_at ? rec.created_at : 'N/A';
            const imgCell = rec.plate_image ? `<img src="${rec.plate_image}" style="max-height:60px" />` : '—';
            const statusText = rec.status == 1 ? 'Trong Bãi' : 'Đã ra';
            const confidenceText = (rec.confidence !== undefined && rec.confidence !== null) ? Math.round(rec.confidence * 100) + '%' : '—';

            const row = `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${created}</td>
                    <td class="text-center">${imgCell}</td>
                    <td>${rec.plate_text}</td>
                    <td class="text-center">${confidenceText}</td>
                    <td class="text-center">${statusText}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info">Chi tiết</button>
                    </td>
                </tr>`;
            tbody.append(row);
        });
    }
</script>
{% endblock %} {% block additional_css %}
<style>
  .custom-file-label::after {
    content: "Duyệt";
  }

  #image-preview {
    border: 2px dashed #ddd;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
  }

  #detected-plate {
    max-height: 150px;
    border-radius: 5px;
  }

  .table th {
    background-color: #e3f2fd;
    color: #1565c0;
    font-weight: 600;
    border-bottom: 2px solid #90caf9;
  }
  .table tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }
  .table tbody tr:nth-child(even) {
    background-color: #e3eafc;
  }
  .table td,
  .table th {
    border: 1px solid #bbdefb;
    vertical-align: middle;
  }
  .table-hover tbody tr:hover {
    background-color: #bbdefb;
    color: #0d47a1;
  }
  .table td {
    color: #222;
  }
</style>
{% endblock %}
