{% extends "layout.html" %} {% block title %}Quản Lý Xe - Quản Lý Bãi Đỗ Xe{%
endblock %} {% block page_title %}Xe Trong Bãi{% endblock %} {% block
nav_vehicles %}active{% endblock %} {% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang Chủ</a></li>
<li class="breadcrumb-item active">Xe Trong Bãi</li>
{% endblock %} {% block main_content %}

<!-- Search and Quick Actions -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Tìm Kiếm Xe</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input
                        type="text"
                        class="form-control"
                        id="search-plate"
                        placeholder="Nhập biển số xe (VD: 30A-12345)"
                        onkeypress="if(event.key==='Enter') searchVehicle()"
                    />
                    <div class="input-group-append">
                        <button
                            class="btn btn-primary"
                            onclick="searchVehicle()"
                        >
                            <i class="fas fa-search"></i> Tìm Kiếm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Thao Tác Nhanh</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input
                        type="text"
                        class="form-control"
                        id="quick-checkout-plate"
                        placeholder="Nhập biển số để cho ra"
                        onkeypress="if(event.key==='Enter') quickCheckout()"
                    />
                    <div class="input-group-append">
                        <button
                            class="btn btn-warning"
                            onclick="quickCheckout()"
                        >
                            <i class="fas fa-sign-out-alt"></i> Cho Ra Ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Danh Sách Xe Đang Trong Bãi</h3>
                <div class="card-tools">
                    <button
                        type="button"
                        class="btn btn-primary btn-sm"
                        onclick="refreshData()"
                    >
                        <i class="fas fa-sync-alt"></i> Làm Mới
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                {% if vehicles %}
                <table
                    class="table table-bordered table-striped"
                    id="vehicles-table"
                >
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Biển Số</th>
                            <th>Thời Gian Vào</th>
                            <th>Thời Gian Đỗ</th>
                            <th>Trạng Thái</th>
                            <th>Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vehicle in vehicles %}
                        <tr id="vehicle-row-{{ vehicle.id }}">
                            <td>{{ loop.index }}</td>
                            <td>
                                <span class="badge badge-primary"
                                    >{{ vehicle.number_plate }}</span
                                >
                            </td>
                            <td>
                                {% if vehicle.created_at %} {{
                                vehicle.created_at.strftime('%H:%M:%S %d/%m/%Y')
                                }} {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td id="duration-{{ vehicle.id }}">
                                <script>
                                    (function() {
                                      const el = document.getElementById('duration-{{ vehicle.id }}');
                                      const createdAt = '{{ vehicle.created_at.isoformat() if vehicle.created_at else None }}';
                                      const dateOut = '{{ vehicle.date_out.isoformat() if vehicle.date_out else None }}';
                                      const status = {{ vehicle.status }};
                                      if (createdAt && status == 1) {
                                        el.innerHTML = calculateDuration(createdAt, null); // Chưa ra bãi, tính đến hiện tại
                                      } else if (createdAt && dateOut) {
                                        el.innerHTML = calculateDuration(createdAt, dateOut); // Đã ra bãi, tính đến date_out
                                      } else {
                                        el.innerHTML = '<span class="text-muted">N/A</span>';
                                      }
                                    })();
                                </script>
                            </td>
                            <td>
                                <span class="badge badge-success"
                                    >Trong Bãi</span
                                >
                            </td>
                            <td>
                                <button
                                    class="btn btn-warning btn-sm checkout-btn"
                                    onclick="checkoutVehicle('{{ vehicle.number_plate }}', {{ vehicle.id }})"
                                    data-plate="{{ vehicle.number_plate }}"
                                    data-id="{{ vehicle.id }}"
                                >
                                    <i class="fas fa-sign-out-alt"></i> Cho Ra
                                </button>
                                <button
                                    class="btn btn-info btn-sm"
                                    onclick="viewDetails('{{ vehicle.id }}')"
                                >
                                    <i class="fas fa-eye"></i> Chi Tiết
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-car fa-3x mb-3"></i>
                    <p>Hiện tại không có xe nào trong bãi</p>
                </div>
                {% endif %}
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ vehicles|length }}</h3>
                <p>Xe Trong Bãi</p>
            </div>
            <div class="icon">
                <i class="fas fa-car"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ 200 - vehicles|length }}</h3>
                <p>Chỗ Trống</p>
            </div>
            <div class="icon">
                <i class="fas fa-parking"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3>{{ (200 - vehicles|length)/200 * 100 }}%</h3>
                <p>Tỷ Lệ Sử Dụng</p>
            </div>
            <div class="icon">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>200</h3>
                <p>Tổng Chỗ Đỗ</p>
            </div>
            <div class="icon">
                <i class="fas fa-warehouse"></i>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block page_plugins %}
<!-- DataTables  & Plugins -->
<script src="{{ url_for('static', filename='plugins/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/datatables-bs4/js/dataTables.bootstrap4.min.js') }}"></script>
{% endblock %} {% block additional_css %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='plugins/datatables-bs4/css/dataTables.bootstrap4.min.css') }}"
/>
{% endblock %} {% block page_scripts %}
<script>
    function calculateDuration(dateInStr, dateOutStr) {
      const dateIn = new Date(dateInStr);
      const dateOut = dateOutStr ? new Date(dateOutStr) : new Date();
      let diffMs = dateOut - dateIn;
      if (diffMs < 0) return "--";
      const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
      let result = '';
      if (days > 0) result += days + ' ngày ';
      if (hours > 0 || days > 0) result += hours + ' giờ ';
      result += minutes + ' phút';
      return result.trim();
    }

    function updateAllDurations() {
      {% for vehicle in vehicles %}
      (function() {
        const el = document.getElementById('duration-{{ vehicle.id }}');
        const createdAt = '{{ vehicle.created_at.isoformat() if vehicle.created_at else None }}';
        const dateOut = '{{ vehicle.date_out.isoformat() if vehicle.date_out else None }}';
        const status = {{ vehicle.status }};
        if (createdAt && status == 1) {
          el.innerHTML = calculateDuration(createdAt, null); // Cập nhật thời gian thực
        } else if (createdAt && dateOut) {
          el.innerHTML = calculateDuration(createdAt, dateOut); // Đã ra bãi
        } else {
          el.innerHTML = '<span class="text-muted">N/A</span>';
        }
      })();
      {% endfor %}
    }

    function refreshData() {
      location.reload();
    }

    function searchVehicle() {
      const plateNumber = document.getElementById('search-plate').value.trim().toUpperCase();
      if (!plateNumber) {
        toastr.warning('Vui lòng nhập biển số xe', 'Cảnh báo');
        return;
      }

      // Hiển thị loading
      toastr.info('Đang tìm kiếm...', 'Thông báo');

      fetch(`/api/search-vehicle?number_plate=${encodeURIComponent(plateNumber)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const vehicle = data.vehicle;
            toastr.success(`Tìm thấy xe ${vehicle.number_plate}`, 'Thành công');

            // Hiển thị thông tin xe trong modal hoặc alert
            const message = `
              <strong>Thông tin xe:</strong><br>
              • Biển số: ${vehicle.number_plate}<br>
              • Thời gian vào: ${vehicle.created_at}<br>
              • Thời gian đỗ: ${vehicle.duration}<br>
              • Trạng thái: ${vehicle.status}
            `;

            // Sử dụng SweetAlert2 nếu có, hoặc alert thông thường
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: 'Thông tin xe',
                html: message,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Cho xe ra',
                cancelButtonText: 'Đóng',
                confirmButtonColor: '#ffc107'
              }).then((result) => {
                if (result.isConfirmed) {
                  checkoutVehicle(vehicle.number_plate, vehicle.id);
                }
              });
            } else {
              alert(message.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, ''));
            }

            // Highlight dòng trong bảng
            highlightVehicleRow(vehicle.id);
          } else {
            toastr.error(data.message, 'Lỗi');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          toastr.error('Lỗi kết nối', 'Lỗi');
        });
    }

    function quickCheckout() {
      const plateNumber = document.getElementById('quick-checkout-plate').value.trim().toUpperCase();
      if (!plateNumber) {
        toastr.warning('Vui lòng nhập biển số xe', 'Cảnh báo');
        return;
      }

      if (confirm(`Xác nhận cho xe ${plateNumber} ra khỏi bãi?`)) {
        performCheckout(plateNumber);
      }
    }

    function checkoutVehicle(plateText, vehicleId) {
      if (confirm(`Xác nhận cho xe ${plateText} ra khỏi bãi?`)) {
        performCheckout(plateText, vehicleId);
      }
    }

    function performCheckout(plateNumber, vehicleId = null) {
      // Disable nút để tránh click nhiều lần
      const buttons = document.querySelectorAll('.checkout-btn');
      buttons.forEach(btn => {
        if (btn.dataset.plate === plateNumber) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
        }
      });

      fetch('/api/checkout-vehicle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          number_plate: plateNumber
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          toastr.success(data.message, "Thành công");

          // Hiển thị thông tin checkout
          const checkoutInfo = `
            Xe đã ra bãi lúc: ${data.checkout_time}
            Thời gian đỗ: ${data.duration}
          `;
          toastr.info(checkoutInfo, "Thông tin", {timeOut: 8000});

          // Xóa dòng khỏi bảng hoặc reload trang
          if (vehicleId) {
            const row = document.getElementById(`vehicle-row-${vehicleId}`);
            if (row) {
              row.style.transition = 'opacity 0.5s';
              row.style.opacity = '0.5';
              setTimeout(() => {
                row.remove();
                // Cập nhật số liệu thống kê
                updateStatistics();
              }, 500);
            }
          } else {
            // Reload trang nếu không có vehicleId
            setTimeout(() => location.reload(), 2000);
          }

          // Clear input fields
          document.getElementById('search-plate').value = '';
          document.getElementById('quick-checkout-plate').value = '';
        } else {
          toastr.error(data.message, "Lỗi");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        toastr.error('Lỗi kết nối', 'Lỗi');
      })
      .finally(() => {
        // Re-enable buttons
        buttons.forEach(btn => {
          if (btn.dataset.plate === plateNumber) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Cho Ra';
          }
        });
      });
    }

    function highlightVehicleRow(vehicleId) {
      // Remove previous highlights
      document.querySelectorAll('.table-warning').forEach(row => {
        row.classList.remove('table-warning');
      });

      // Highlight current row
      const row = document.getElementById(`vehicle-row-${vehicleId}`);
      if (row) {
        row.classList.add('table-warning');
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Remove highlight after 3 seconds
        setTimeout(() => {
          row.classList.remove('table-warning');
        }, 3000);
      }
    }

    function updateStatistics() {
      // Cập nhật số liệu thống kê trong các card
      const currentCount = document.querySelectorAll('#vehicles-table tbody tr').length;
      const totalSpots = 200;
      const availableSpots = totalSpots - currentCount;
      const usageRate = ((currentCount / totalSpots) * 100).toFixed(1);

      // Cập nhật các giá trị (nếu có elements)
      const elements = [
        { selector: '.small-box.bg-info .inner h3', value: currentCount },
        { selector: '.small-box.bg-success .inner h3', value: availableSpots },
        { selector: '.small-box.bg-warning .inner h3', value: usageRate + '%' }
      ];

      elements.forEach(({selector, value}) => {
        const el = document.querySelector(selector);
        if (el) el.textContent = value;
      });
    }

    function viewDetails(vehicleId) {
      toastr.info("Chức năng xem chi tiết sẽ được phát triển", "Thông báo");
    }

    $(document).ready(function () {
      $("#vehicles-table").DataTable({
        responsive: true,
        lengthChange: false,
        autoWidth: false,
        language: {
          search: "Tìm kiếm:",
          lengthMenu: "Hiển thị _MENU_ mục",
          info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
          infoEmpty: "Hiển thị 0 đến 0 của 0 mục",
          infoFiltered: "(lọc từ _MAX_ tổng số mục)",
          paginate: {
            first: "Đầu",
            last: "Cuối",
            next: "Tiếp",
            previous: "Trước",
          },
        },
      });
      updateAllDurations();
      setInterval(updateAllDurations, 60000);
    });
</script>
{% endblock %}
